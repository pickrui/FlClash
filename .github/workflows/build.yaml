name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g., v0.8.90)'
        required: false
        type: string
      is_stable:
        description: 'Is stable release'
        required: false
        type: boolean
        default: true
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false

env:
  IS_STABLE: ${{ github.event_name == 'workflow_dispatch' && inputs.is_stable == true || (github.event_name == 'push' && !contains(github.ref, '-')) }}
  GO_VERSION: '1.25'
  FLUTTER_CHANNEL: 'stable'

jobs:
  build:
    name: Build ${{ matrix.platform }}-${{ matrix.arch || 'all' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: macos-latest
            arch: null
          - platform: windows
            os: windows-2022
            arch: amd64
          - platform: linux
            os: ubuntu-22.04
            arch: amd64
          - platform: linux
            os: ubuntu-24.04-arm
            arch: arm64
          - platform: macos
            os: macos-15-intel
            arch: amd64
          - platform: macos
            os: macos-latest
            arch: arm64

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: ${{ github.ref }}

      - name: Create Tag (if provided)
        if: github.event_name == 'workflow_dispatch' && inputs.tag != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git rev-parse "${{ inputs.tag }}" >/dev/null 2>&1; then
            git checkout "${{ inputs.tag }}"
          else
            git tag "${{ inputs.tag }}"
            git push origin "${{ inputs.tag }}"
            git checkout "${{ inputs.tag }}"
          fi

      - name: Install Linux Dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libayatana-appindicator3-dev \
            libsecret-1-dev libjsoncpp-dev

      - name: Setup Linux Build Cache
        if: matrix.platform == 'linux'
        uses: actions/cache@v4
        with:
          path: |
            build/linux
            ~/.cache
          key: ${{ runner.os }}-linux-${{ matrix.arch }}-${{ hashFiles('**/CMakeLists.txt', '**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-linux-${{ matrix.arch }}-
            ${{ runner.os }}-linux-

      - name: Setup Windows Build Cache
        if: matrix.platform == 'windows'
        uses: actions/cache@v4
        with:
          path: |
            build/windows
            ~/AppData/Local/Temp/chocolatey
          key: ${{ runner.os }}-windows-${{ matrix.arch }}-${{ hashFiles('**/CMakeLists.txt', '**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-windows-${{ matrix.arch }}-
            ${{ runner.os }}-windows-

      - name: Setup Gradle Cache
        if: matrix.platform == 'android'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Pub Cache
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Setup CocoaPods Cache
        if: matrix.platform == 'macos'
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
            macos/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Setup Xcode DerivedData Cache
        if: matrix.platform == 'macos'
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-${{ matrix.arch }}-${{ hashFiles('macos/**/*.pbxproj', 'macos/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-xcode-${{ matrix.arch }}-
            ${{ runner.os }}-xcode-

      - name: Setup Android Signing
        if: matrix.platform == 'android'
        run: |
          set -e
          echo "${{ secrets.KEYSTORE }}" | base64 --decode > android/app/keystore.jks
          if [ ! -s android/app/keystore.jks ]; then
            echo "Error: keystore.jks is empty or failed to decode"
            exit 1
          fi
          if [ -f android/local.properties ]; then
            cat >> android/local.properties << EOF
          keyAlias=${{ secrets.KEY_ALIAS }}
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
          else
            cat > android/local.properties << EOF
          keyAlias=${{ secrets.KEY_ALIAS }}
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
          fi
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: core/go.sum

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ startsWith(matrix.os, 'ubuntu-24.04-arm') && 'master' || env.FLUTTER_CHANNEL }}
          architecture: ${{ (matrix.platform == 'android' || (matrix.platform == 'macos' && matrix.os == 'macos-latest')) && 'x64' || '' }}
          cache: true

      - name: Install Flutter Dependencies
        run: flutter pub get

      - name: Update Version (Pre-build)
        if: matrix.platform == 'android'
        shell: bash
        env:
          TZ: UTC
        run: |
          set -e
          dart setup.dart android --out core || true
          echo "Version updated before build"

      - name: Build Application
        id: build
        shell: bash
        env:
          TZ: UTC
        run: |
          set -e
          BUILD_ARGS="${{ matrix.platform }}"
          [ -n "${{ matrix.arch }}" ] && BUILD_ARGS="$BUILD_ARGS --arch ${{ matrix.arch }}"
          BUILD_ARGS="$BUILD_ARGS --out app"
          [ "${{ env.IS_STABLE }}" == "true" ] && BUILD_ARGS="$BUILD_ARGS --env stable"
          dart setup.dart $BUILD_ARGS

      - name: Verify Build Output
        id: check_output
        shell: bash
        run: |
          if [ -d "./dist" ] && [ -n "$(ls -A ./dist 2>/dev/null)" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Build Artifacts
        if: steps.build.outcome == 'success' && steps.check_output.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.platform }}-${{ matrix.arch || 'default' }}-${{ github.run_number }}
          path: ./dist
          retention-days: 7
          compression-level: 6

      - name: Cleanup Sensitive Files
        if: always() && matrix.platform == 'android'
        run: |
          rm -f android/app/keystore.jks android/local.properties

  changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    needs: [build]
    if: success() && github.event_name == 'push' && !contains(github.ref, '-')
    timeout-minutes: 10
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/heads/main

      - name: Generate Changelog
        run: |
          set -e
          mapfile -t tags < <(git tag --merged HEAD --sort=-creatordate)
          preTag=$(grep -oP '^## \K.*' CHANGELOG.md | head -n 1 || echo "")
          currentTag=""
          for ((i = 0; i <= ${#tags[@]}; i++)); do
            tag=$([ $i -lt ${#tags[@]} ] && echo "${tags[$i]}" || echo "")
            if [ -n "$currentTag" ]; then
              [ "$(echo -e "$currentTag\n$preTag" | sort -V | head -n 1)" == "$currentTag" ] && break
              echo "## $currentTag" >> NEW_CHANGELOG.md
              echo "" >> NEW_CHANGELOG.md
              if [ -n "$tag" ]; then
                git log --pretty=format:"%B" "$tag..$currentTag" | awk 'NF {print "- " $0} !NF {print ""}' >> NEW_CHANGELOG.md
              else
                git log --pretty=format:"%B" "$currentTag" | awk 'NF {print "- " $0} !NF {print ""}' >> NEW_CHANGELOG.md
              fi
              echo "" >> NEW_CHANGELOG.md
            fi
            currentTag=$tag
          done
          cat CHANGELOG.md >> NEW_CHANGELOG.md
          mv NEW_CHANGELOG.md CHANGELOG.md

      - name: Commit and Push Changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git commit -m "docs: update changelog for ${{ github.ref_name }}"
            git push
          fi

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build]
    if: success() && ((github.event_name == 'workflow_dispatch' && inputs.is_stable == true) || (github.event_name == 'push' && !contains(github.ref, '-')) || (github.event_name == 'workflow_dispatch' && inputs.create_release == true))
    timeout-minutes: 20
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist/
          pattern: artifact-*
          merge-multiple: true

      - name: Generate Release Notes
        run: |
          set -e
          VERSION_TAG="${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}"
          mapfile -t tags < <(git tag --merged HEAD --sort=-creatordate)
          preTag=$(curl -sf "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
                   grep -Po '"tag_name": "\K.*?(?=")' || echo "")
          currentTag=""
          for ((i = 0; i <= ${#tags[@]}; i++)); do
            tag=$([ $i -lt ${#tags[@]} ] && echo "${tags[$i]}" || echo "")
            if [ -n "$currentTag" ]; then
              [ "$(echo -e "$currentTag\n$preTag" | sort -V | head -n 1)" == "$currentTag" ] && break
              if [ "$currentTag" == "$VERSION_TAG" ]; then
                if [ -n "$tag" ]; then
                  git log --pretty=format:"%B" "$tag..$currentTag" | awk 'NF {print "- " $0} !NF {print ""}' >> release.md
                else
                  git log --pretty=format:"%B" "$currentTag" | awk 'NF {print "- " $0} !NF {print ""}' >> release.md
                fi
                echo "" >> release.md
                break
              fi
            fi
            currentTag=$tag
          done

      - name: Append Release Template
        run: |
          VERSION_TAG="${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}"
          version=$(echo "$VERSION_TAG" | sed 's/^v//')
          if [ -f "./.github/release_template.md" ]; then
            sed "s|VERSION|$version|g" ./.github/release_template.md >> release.md
          fi

      - name: Publish Previous Draft
        if: (github.event_name == 'workflow_dispatch' && inputs.is_stable == true) || (github.event_name == 'push' && !contains(github.ref, '-'))
        continue-on-error: true
        run: |
          RELEASE_TAG="${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}"
          release_info=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG" || echo "")
          if [ -z "$release_info" ]; then
            exit 0
          fi
          is_draft=$(echo "$release_info" | grep -o '"draft":[^,]*' | grep -o '[^:]*$' || echo "false")
          if [ "$is_draft" = "true" ]; then
            release_id=$(echo "$release_info" | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)
            curl -sf -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$release_id" \
              -d '{"draft":false,"prerelease":false}'
          fi

      - name: Create GitHub Release
        if: (github.event_name == 'workflow_dispatch' && inputs.is_stable == true) || (github.event_name == 'push' && !contains(github.ref, '-')) || (github.event_name == 'workflow_dispatch' && inputs.create_release == true)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          files: ./dist/*
          body_path: './release.md'
          draft: false
          prerelease: ${{ !((github.event_name == 'workflow_dispatch' && inputs.is_stable == true) || (github.event_name == 'push' && !contains(github.ref, '-'))) }}
          make_latest: legacy
          generate_release_notes: false
          fail_on_unmatched_files: false

      - name: Update Version via Dler API
        if: (github.event_name == 'workflow_dispatch' && inputs.is_stable == true) || (github.event_name == 'push' && !contains(github.ref, '-'))
        continue-on-error: true
        run: |
          VERSION_TAG="${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}"
          VERSION=$(echo "$VERSION_TAG" | sed 's/^v//')
          API_KEY="${{ secrets.DLER_KEY }}"
          API_URL="https://dlercloud.com/api/v1/version/update"
          
          if [ -z "$API_KEY" ]; then
            echo "Warning: DLER_KEY secret is not set, skipping version update"
            exit 0
          fi
          
          response=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "key=$API_KEY&version=$VERSION")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "Version updated successfully: $VERSION"
            echo "Response: $body"
          else
            echo "Failed to update version. HTTP code: $http_code"
            echo "Response: $body"
            exit 1
          fi